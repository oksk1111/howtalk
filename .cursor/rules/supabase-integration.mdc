---
alwaysApply: true
---
# Supabase í†µí•© ê°€ì´ë“œ

## ğŸ”§ Supabase í´ë¼ì´ì–¸íŠ¸ ì„¤ì •

### í´ë¼ì´ì–¸íŠ¸ ì¸ìŠ¤í„´ìŠ¤
**ëª¨ë“  Supabase ì‘ì—…ì€ [src/integrations/supabase/client.ts](mdc:src/integrations/supabase/client.ts)ì—ì„œ exportëœ í´ë¼ì´ì–¸íŠ¸ë¥¼ ì‚¬ìš©:**

```typescript
import { supabase } from '@/integrations/supabase/client';

// âœ… ì˜¬ë°”ë¥¸ ì‚¬ìš©ë²•
const { data, error } = await supabase.from('messages').select('*');

// âŒ ìƒˆë¡œìš´ í´ë¼ì´ì–¸íŠ¸ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ê¸ˆì§€
// const client = createClient(url, key);
```

### íƒ€ì… ì•ˆì „ì„± ë³´ì¥
**[src/integrations/supabase/types.ts](mdc:src/integrations/supabase/types.ts)ì˜ íƒ€ì…ì„ í•­ìƒ í™œìš©:**

```typescript
import type { Database } from '@/integrations/supabase/types';

// í…Œì´ë¸” íƒ€ì… ì¶”ì¶œ
type Profile = Database['public']['Tables']['profiles']['Row'];
type MessageInsert = Database['public']['Tables']['messages']['Insert'];
type ChatRoom = Database['public']['Tables']['chat_rooms']['Row'];
```

## ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ë° ê´€ê³„

### í•µì‹¬ í…Œì´ë¸” êµ¬ì¡°
1. **profiles** - ì‚¬ìš©ì í”„ë¡œí•„
2. **chat_rooms** - ì±„íŒ…ë°© (ê°œì¸/ê·¸ë£¹)
3. **chat_participants** - ì±„íŒ…ë°© ì°¸ì—¬ì
4. **messages** - ë©”ì‹œì§€ (AI í˜ë¥´ì†Œë‚˜ ì§€ì›)
5. **friendships** - ì¹œêµ¬ ê´€ê³„

### ê´€ê³„í˜• ì¿¼ë¦¬ íŒ¨í„´
```typescript
// ì±„íŒ…ë°©ê³¼ ì°¸ì—¬ì ì¡°ì¸
const { data: chatRooms } = await supabase
  .from('chat_rooms')
  .select(`
    *,
    chat_participants (
      user_id,
      profiles (
        display_name,
        avatar_url
      )
    )
  `)
  .eq('created_by', userId);

// ë©”ì‹œì§€ì™€ ë°œì‹ ì ì •ë³´ ì¡°ì¸
const { data: messages } = await supabase
  .from('messages')
  .select(`
    *,
    profiles:sender_id (
      display_name,
      avatar_url
    )
  `)
  .eq('room_id', roomId)
  .order('created_at', { ascending: true });
```

## ğŸ” ì¸ì¦ ì‹œìŠ¤í…œ íŒ¨í„´

### ì¸ì¦ ìƒíƒœ ê´€ë¦¬
**[src/hooks/useAuth.tsx](mdc:src/hooks/useAuth.tsx) í›…ì„ í†µí•´ ì¸ì¦ ì²˜ë¦¬:**

```typescript
import { useAuth } from '@/hooks/useAuth';

// ì»´í¬ë„ŒíŠ¸ì—ì„œ ì¸ì¦ ìƒíƒœ í™•ì¸
const { user, session, loading, signIn, signUp, signOut } = useAuth();

// ë¡œê·¸ì¸ ì²˜ë¦¬
const handleSignIn = async (email: string, password: string) => {
  const { error } = await signIn(email, password);
  if (error) {
    // ì—ëŸ¬ ì²˜ë¦¬
  }
};
```

### ì¸ì¦ ê°€ë“œ íŒ¨í„´
```typescript
// í˜ì´ì§€ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì¸ì¦ í™•ì¸
const { user, loading } = useAuth();
const navigate = useNavigate();

useEffect(() => {
  if (!loading && !user) {
    navigate('/auth');
  }
}, [user, loading, navigate]);

if (loading) return <LoadingComponent />;
if (!user) return <AuthPrompt />;
```

## ğŸ“¨ ì‹¤ì‹œê°„ ë°ì´í„° êµ¬ë…

### ì‹¤ì‹œê°„ ë©”ì‹œì§€ êµ¬ë…
```typescript
// ì±„íŒ…ë°© ë©”ì‹œì§€ ì‹¤ì‹œê°„ êµ¬ë…
useEffect(() => {
  if (!roomId) return;

  const channel = supabase
    .channel(`room-${roomId}`)
    .on(
      'postgres_changes',
      {
        event: 'INSERT',
        schema: 'public',
        table: 'messages',
        filter: `room_id=eq.${roomId}`
      },
      (payload) => {
        setMessages(prev => [...prev, payload.new as Message]);
      }
    )
    .subscribe();

  return () => {
    supabase.removeChannel(channel);
  };
}, [roomId]);
```

### ì‚¬ìš©ì ìƒíƒœ êµ¬ë…
```typescript
// ì¹œêµ¬ ì˜¨ë¼ì¸ ìƒíƒœ êµ¬ë…
useEffect(() => {
  const channel = supabase
    .channel('user-status')
    .on(
      'postgres_changes',
      {
        event: 'UPDATE',
        schema: 'public',
        table: 'profiles',
        filter: `user_id=in.(${friendIds.join(',')})`
      },
      (payload) => {
        updateFriendStatus(payload.new);
      }
    )
    .subscribe();

  return () => supabase.removeChannel(channel);
}, [friendIds]);
```

## ğŸ’¾ ë°ì´í„° ì¡°ì‘ íŒ¨í„´

### ë©”ì‹œì§€ ì „ì†¡
```typescript
const sendMessage = async (
  content: string, 
  roomId: string, 
  aiPersona?: string
): Promise<boolean> => {
  try {
    const { error } = await supabase
      .from('messages')
      .insert({
        content,
        room_id: roomId,
        sender_id: user.id,
        message_type: aiPersona ? 'ai_generated' : 'text',
        ai_persona: aiPersona
      });

    if (error) throw error;
    return true;
  } catch (error) {
    console.error('Failed to send message:', error);
    return false;
  }
};
```

### ì±„íŒ…ë°© ìƒì„±
```typescript
const createChatRoom = async (
  participantIds: string[], 
  isGroup: boolean = false,
  name?: string
): Promise<string | null> => {
  try {
    // ì±„íŒ…ë°© ìƒì„±
    const { data: room, error: roomError } = await supabase
      .from('chat_rooms')
      .insert({
        created_by: user.id,
        is_group: isGroup,
        name: name || null
      })
      .select()
      .single();

    if (roomError) throw roomError;

    // ì°¸ì—¬ì ì¶”ê°€
    const participants = participantIds.map(userId => ({
      room_id: room.id,
      user_id: userId
    }));

    const { error: participantsError } = await supabase
      .from('chat_participants')
      .insert(participants);

    if (participantsError) throw participantsError;

    return room.id;
  } catch (error) {
    console.error('Failed to create chat room:', error);
    return null;
  }
};
```

## ğŸ” ì¿¼ë¦¬ ìµœì í™” ê°€ì´ë“œ

### íš¨ìœ¨ì ì¸ ë°ì´í„° í˜ì¹­
```typescript
// í•„ìš”í•œ í•„ë“œë§Œ ì„ íƒ
const { data } = await supabase
  .from('profiles')
  .select('user_id, display_name, avatar_url, status')
  .in('user_id', userIds);

// í˜ì´ì§€ë„¤ì´ì…˜ ì ìš©
const { data } = await supabase
  .from('messages')
  .select('*')
  .eq('room_id', roomId)
  .order('created_at', { ascending: false })
  .range(offset, offset + limit);

// ì¸ë±ìŠ¤ í™œìš©ì„ ìœ„í•œ í•„í„° ìˆœì„œ
const { data } = await supabase
  .from('messages')
  .select('*')
  .eq('room_id', roomId)  // ì¸ë±ìŠ¤ê°€ ìˆëŠ” í•„ë“œ ìš°ì„ 
  .eq('message_type', 'text')
  .gte('created_at', startDate);
```

## ğŸš¨ ì—ëŸ¬ ì²˜ë¦¬ íŒ¨í„´

### í‘œì¤€ ì—ëŸ¬ ì²˜ë¦¬
```typescript
const performDatabaseOperation = async () => {
  try {
    const { data, error } = await supabase
      .from('table_name')
      .insert(payload);

    if (error) {
      // Supabase ì—ëŸ¬ ì²˜ë¦¬
      if (error.code === '23505') {
        throw new Error('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë°ì´í„°ì…ë‹ˆë‹¤.');
      }
      throw new Error(error.message);
    }

    return { success: true, data };
  } catch (error: any) {
    console.error('Database operation failed:', error);
    return { success: false, error: error.message };
  }
};
```

### RLS (Row Level Security) ì¤€ìˆ˜
```typescript
// ì‚¬ìš©ìë³„ ë°ì´í„° ì ‘ê·¼ ì œí•œ í™•ì¸
const fetchUserMessages = async (userId: string) => {
  // RLS ì •ì±…ì— ì˜í•´ ìë™ìœ¼ë¡œ ì‚¬ìš©ì ê¶Œí•œ í™•ì¸ë¨
  const { data, error } = await supabase
    .from('messages')
    .select('*')
    .eq('sender_id', userId);  // RLSë¡œ ì ‘ê·¼ ì œì–´ë¨

  return { data, error };
};
```