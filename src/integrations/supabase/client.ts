// This file is automatically generated. Do not edit it directly.
import { createClient } from '@supabase/supabase-js';
import type { Database } from './types';

const SUPABASE_URL = import.meta.env.VITE_SUPABASE_URL;
const SUPABASE_PUBLISHABLE_KEY = import.meta.env.VITE_SUPABASE_ANON_KEY;

// ë””ë²„ê¹…ìš© í™˜ê²½ë³€ìˆ˜ ì¶œë ¥
console.log('ğŸ”§ Supabase Client í™˜ê²½ë³€ìˆ˜ ì²´í¬:', {
  SUPABASE_URL,
  SUPABASE_PROJECT_ID: import.meta.env.VITE_SUPABASE_PROJECT_ID,
  SUPABASE_PUBLISHABLE_KEY_LENGTH: SUPABASE_PUBLISHABLE_KEY?.length,
  SUPABASE_PUBLISHABLE_KEY_PREFIX: SUPABASE_PUBLISHABLE_KEY?.substring(0, 20),
  ALL_ENV_VARS: Object.keys(import.meta.env).filter(key => key.includes('SUPABASE'))
});

if (!SUPABASE_URL) {
  console.error('âŒ Missing VITE_SUPABASE_URL environment variable');
  throw new Error('Missing VITE_SUPABASE_URL environment variable');
}

if (!SUPABASE_PUBLISHABLE_KEY) {
  console.error('âŒ Missing VITE_SUPABASE_ANON_KEY environment variable');
  throw new Error('Missing VITE_SUPABASE_ANON_KEY environment variable');
}

// Import the supabase client like this:
// import { supabase } from "@/integrations/supabase/client";

export const supabase = createClient<Database>(SUPABASE_URL, SUPABASE_PUBLISHABLE_KEY, {
  auth: {
    storage: localStorage,
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true, // URLì—ì„œ ì„¸ì…˜ ê°ì§€ í™œì„±í™”
  },
  db: {
    schema: 'public'
  },
  realtime: {
    params: {
      eventsPerSecond: 10
    }
  },
  global: {
    headers: {
      'X-Client-Info': 'supabase-js-web'
    },
    fetch: (url, options = {}) => {
      // 30ì´ˆ íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ì¦ê°€
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 30000);
      
      return fetch(url, {
        ...options,
        signal: controller.signal,
      }).finally(() => {
        clearTimeout(timeoutId);
      });
    }
  }
});

// ì—°ê²° í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
export const testSupabaseConnection = async () => {
  try {
    console.log('ğŸ” Supabase ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘...');
    
    // 1. ê¸°ë³¸ ì—°ê²° í…ŒìŠ¤íŠ¸ (ê°„ë‹¨í•œ profiles í…Œì´ë¸” ì¡°íšŒ)
    console.log('â³ DB ì¿¼ë¦¬ ì‹¤í–‰ ì¤‘...');
    
    const dbResult = await Promise.race([
      supabase.from('profiles').select('user_id').limit(1),
      new Promise((_, reject) => 
        setTimeout(() => reject(new Error('DB ì—°ê²° ì‹œê°„ ì´ˆê³¼ (5ì´ˆ)')), 5000)
      )
    ]);
    
    const { data, error } = dbResult as any;
    
    if (error) {
      console.error('âŒ Supabase DB ì—°ê²° ì‹¤íŒ¨:', error);
      return { success: false, error };
    }
    
    console.log('âœ… Supabase DB ì—°ê²° ì„±ê³µ:', data);
    
    // 2. ì¸ì¦ ìƒíƒœ í™•ì¸
    console.log('ğŸ” ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘...');
    
    const authResult = await Promise.race([
      supabase.auth.getSession(),
      new Promise((_, reject) => 
        setTimeout(() => reject(new Error('ì¸ì¦ í™•ì¸ ì‹œê°„ ì´ˆê³¼ (5ì´ˆ)')), 5000)
      )
    ]);
    
    const { data: authData, error: authError } = authResult as any;
    
    console.log('ğŸ” í˜„ì¬ ì¸ì¦ ìƒíƒœ:', { 
      hasSession: !!authData.session,
      userId: authData.session?.user?.id,
      authError 
    });
    
    return { success: true, data, authData };
  } catch (error) {
    console.error('ğŸ’¥ Supabase ì—°ê²° í…ŒìŠ¤íŠ¸ ì˜ˆì™¸:', error);
    return { success: false, error };
  }
};

// í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ìœ¼ë¡œ ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
setTimeout(() => {
  testSupabaseConnection();
}, 1000);

// ë””ë²„ê¹…ì„ ìœ„í•´ window ê°ì²´ì— í•¨ìˆ˜ë“¤ ì¶”ê°€
if (typeof window !== 'undefined') {
  (window as any).supabase = supabase;
  (window as any).testSupabaseConnection = testSupabaseConnection;
  (window as any).debugSupabase = {
    testConnection: testSupabaseConnection,
    getEnvVars: () => ({
      SUPABASE_URL,
      SUPABASE_PROJECT_ID: import.meta.env.VITE_SUPABASE_PROJECT_ID,
      SUPABASE_PUBLISHABLE_KEY: SUPABASE_PUBLISHABLE_KEY?.substring(0, 20) + '...',
      ALL_ENV: import.meta.env
    }),
    getSession: () => supabase.auth.getSession(),
    getUser: () => supabase.auth.getUser(),
    signOut: () => supabase.auth.signOut(),
    testDB: () => supabase.from('profiles').select('user_id').limit(1),
    testRealtime: () => {
      console.log('ğŸ”” ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸ ì‹œì‘...');
      const channel = supabase
        .channel('test_channel')
        .on('postgres_changes', {
          event: '*',
          schema: 'public',
          table: 'messages'
        }, (payload) => {
          console.log('ğŸ“¨ ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ìˆ˜ì‹ :', payload);
        })
        .subscribe((status) => {
          console.log('ğŸ“¡ ì‹¤ì‹œê°„ êµ¬ë… ìƒíƒœ:', status);
        });
      
      // 10ì´ˆ í›„ ìë™ í•´ì œ
      setTimeout(() => {
        supabase.removeChannel(channel);
        console.log('ğŸ”• ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸ ì™„ë£Œ');
      }, 10000);
      
      return channel;
    }
  };
  
  console.log('ğŸ® ë””ë²„ê¹… ë„êµ¬ê°€ window ê°ì²´ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤:');
  console.log('- window.supabase: Supabase í´ë¼ì´ì–¸íŠ¸');
  console.log('- window.testSupabaseConnection(): ì—°ê²° í…ŒìŠ¤íŠ¸');
  console.log('- window.debugSupabase: ë””ë²„ê¹… ìœ í‹¸ë¦¬í‹°');
  console.log('- window.debugSupabase.testRealtime(): ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸');
}